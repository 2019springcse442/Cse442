<?php
	include 'database.php';
?>

<!DOCTYPE html>

<html>
<head>
  <title>Professor's Profile</title>
    <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah|Laila" rel="stylesheet">
    <link rel="stylesheet" href="ScheduleMatching.css">
    <meta charset = "utf-8">
    <meta name ="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
    <script>
function getVote(int) {
  if (window.XMLHttpRequest) {
    // IE7+, Firefox, Chrome, Opera, Safari 执行代码
    xmlhttp=new XMLHttpRequest();
  } else {
    // IE6, IE5 执行代码
    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange=function() {
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
      document.getElementById("poll").innerHTML=xmlhttp.responseText;
    }
  }
  xmlhttp.open("GET","poll_vote.php?vote="+int,true);
  xmlhttp.send();
}

</script>
  </head>
  <body>
    <nav>
      <div class = "logo" href="homepage.html">
        <h3> UBStalking'-' </h3>
      </div>

      <form action="" method="post">
          <input type = "text" name = "search" id = "search-bar" placeholder = "Search for your professors!" value ="" maxlength ="50"
          autocompleete = "off" onMousedown ="" onBlur = "" /><input type = "submit" name = "submit-search"  id = "search-btn" value="Go!"/>
      </form>

      <input type="checkbox" id="nav-toggle" class="nav-toggle"/>

        <div class="menu">
          <ul>
          <li>
          <a href="homepage.php">Home</a></li>
          <li>
          <a href="OfficeNavigation.html">Office Navigation</a></li>
          <li>
          <a href="ScheduleMatching.html">Schedule Matching</a></li>
          <li>
          <a href="#">Report Bugs</a></li>
          </ul>
      </div>

      <label for="nav-toggle" class="burger"><span></span></label>
    </nav>

<h2>Find the professors:<h2>

<div class = "professor-container">
  <?php
  	if(isset($_POST['submit-search'])){
  		$search = mysqli_real_escape_string($con, $_POST['search']);
  		$sql = "SELECT * FROM message WHERE name LIKE '%$search%'";
    	$result = mysqli_query($con, $sql);
    	$queryResults = mysqli_num_rows($result);

    	if($queryResults >0){
    		while($row = mysqli_fetch_assoc($result)){
      		echo "<div>
        	<h2>".$row['name']."</h2>
        	<p>".$row['Office']."</p>
        	<p>".$row['Hours']."</p>
        	<p>".$row['Current course']."</p>
      		</div>";
    }

    	}else{
    		echo "There are no result matching your search!";
    	}
  	}
  ?>

<div id="poll">
<h3>Do you like this professor?</h3>
<form>
Yes:
<input type="radio" name="vote" value="0" onclick="getVote(this.value)">
<br>No:
<input type="radio" name="vote" value="1" onclick="getVote(this.value)">
</form>
</div>




</div>
<br></br>
<h2>Rate this Professor</h2>
    <input type='text' id='messageInput'  placeholder='Enter comments here...'>
    <button type="button" onclick="savedata()">Post & Save</button>
    <br><br><br>
    <hr>
    <h2>Comments</h2>
    <textarea rows="10" cols="50" id="results" readonly></textarea>
    <script>
    var messagesRef = new Firebase('https://ubstalking-19cf2.firebaseio.com/');
    var messageField = document.getElementById('messageInput');
    var messageResults = document.getElementById('results');
    // Save data to firebase
    function savedata(){
      var message = messageField.value;
      messagesRef.push({fieldName:'messageField', text:message});
      messageField.value = '';
    }
    // Update results when data is added
    messagesRef.limitToLast(10).on('child_added', function (snapshot) {
        var data = snapshot.val();
        console.log(snapshot.val());
        var message = data.text;
        if (message != undefined)
        {
          messageResults.value += '\n' + message;
        }
    });
    </script>
<br></hr>
<h3>Send email to this professor</h3>



<?php
// 定义变量并默认设置为空值
$nameErr = $emailErr = $genderErr = $websiteErr = "";
$name = $email = $gender = $comment = $website = "";

if ($_SERVER["REQUEST_METHOD"] == "POST") {
   if (empty($_POST["name"])) {
      $nameErr = "Name is required";
      } else {
         $name = test_input($_POST["name"]);
         // 检测名字是否只包含字母跟空格
         if (!preg_match("/^[a-zA-Z ]*$/",$name)) {
         $nameErr = "Only letters and spaces are allowed"; 
         }
     }
   
   if (empty($_POST["email"])) {
      $emailErr = "Email is required";
   } else {
      $email = test_input($_POST["email"]);
      // 检测邮箱是否合法
      if (!preg_match("/([\w\-]+\@[\w\-]+\.[\w\-]+)/",$email)) {
         $emailErr = "Illegal mailbox format"; 
      }
   }
     
   if (empty($_POST["website"])) {
      $website = "";
   } else {
      $website = test_input($_POST["website"]);
      // 检测 URL 地址是否合法
     if (!preg_match("/\b(?:(?:https?|ftp):\/\/|www\.)[-a-z0-9+&@#\/%?=~_|!:,.;]*[-a-z0-9+&@#\/%=~_|]/i",$website)) {
         $websiteErr = "Illegal URL address"; 
      }
   }

   if (empty($_POST["comment"])) {
      $comment = "";
   } else {
      $comment = test_input($_POST["comment"]);
   }

   if (empty($_POST["gender"])) {
      $genderErr = "Make sure professor knows you";
   } else {
      $gender = test_input($_POST["gender"]);
   }
}

function test_input($data) {
   $data = trim($data);
   $data = stripslashes($data);
   $data = htmlspecialchars($data);
   return $data;
}
?>

<h2>Send professor email</h2>
<p><span class="error">* Necessary</span></p>
<form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]);?>"> 
   Your name: <input type="text" name="name">
   <span class="error">* <?php echo $nameErr;?></span>
   <br><br>
   E-mail: <input type="text" name="email">
   <span class="error">* <?php echo $emailErr;?></span>
   <br><br>
   Message: <textarea name="comment" rows="5" cols="40"></textarea>
   <br><br>
   Are you professor student?
   <input type="radio" name="gender" value="female">Yes
   <input type="radio" name="gender" value="male">No
   <span class="error">* <?php echo $genderErr;?></span>
   <br><br>
   <input type="submit" name="submit" value="Submit"> 
</form>

<?php


class customException extends Exception
{
    public function errorMessage()
    {
        // 错误信息
        $errorMsg = 'Illegal email';
        return $errorMsg;
    }
}
 
 
try
{
    // 检测邮箱
    if(filter_var($email, FILTER_VALIDATE_EMAIL) === FALSE)
    {
        // 如果是个不合法的邮箱地址，抛出异常
        throw new customException($email);
    }
    // 检测 "example" 是否在邮箱地址中
    if(strpos($email, "example") !== FALSE)
    {
        throw new Exception("$email 是 example 邮箱");
    }
}
catch (customException $e)
{
    echo $e->errorMessage();
}
catch(Exception $e)
{
    echo $e->getMessage();
}

echo "<h2>you info:</h2>";
echo $name;
echo "<br>";
echo $email;
echo "<br>";
echo $comment;
echo "<br>";
echo $gender;
?>

    </body>
</html>
